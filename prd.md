# 项目需求文档（PRD）

## 1. 概述
项目名称：零部件采购成本与机会分析系统 (PCO-BI)
目标用户：采购总监、品类经理、一线采购员
核心价值：解决Excel手工分析效率低、可视化差、缺乏深度洞察的问题。通过自动化数据清洗、多维度可视化（如机会矩阵）及AI智能辅助，帮助团队快速识别降本机会（Opportunity）并制定谈判策略。

## 2. 功能需求

| 功能 | 优先级 | 描述 | 验收标准 |
|-----|-------|------|---------|
| **Excel上传与智能映射** | P0 必需 | 支持.xlsx/.csv上传；系统自动模糊匹配表头（如识别"Qty"为"Quantity"），并提供用户确认界面。 | 1. 上传5万行Excel无卡顿<br>2. 能准确识别不同命名习惯的表头<br>3. 用户必须确认映射后才进行下一步 |
| **全局仪表盘 (Global)** | P0 必需 | 展示总支出(APV)、覆盖率、总机会金额等KPI；展示**机会矩阵气泡图** (X轴支出/Y轴差异率/气泡大小为机会金额)。 | 1. 气泡图交互流畅，悬停显示详情<br>2. KPI数据与Excel求和结果一致（严禁汇率换算） |
| **品类详情分析 (Commodity)** | P0 必需 | 按品类下钻分析，包含供应商集中度(CR5)分析、Top供应商排名(APV vs Gap%)、Top零件列表。 | 1. 能够识别单一来源风险<br>2. 列表按机会金额降序排列 |
| **高清导出** | P0 必需 | 将当前分析报告导出为PDF或PPT，要求所见即所得，包含图表与AI分析文本。 | 1. PDF/PPT清晰度高（矢量或高倍图）<br>2. 包含Nexteer Logo和保密声明页脚 |
| **供应商详情与沙箱** | P1 重要 | 展示单一供应商画像；提供**动态模拟器**，用户输入新报价后，图表即时增加对比柱状图。 | 1. 模拟器无需刷新页面，实时更新图表<br>2. 展示该供应商Top 10降本机会零件 |
| **LLM 智能分析报告** | P1 重要 | 集成LLM（兼容OpenAI/Kimi/Qwen），基于当前页面统计数据生成谈判策略或风险分析文本。 | 1. 支持配置不同模型的API Key和BaseURL<br>2. 生成结果以Markdown流式展示<br>3. 包含数据脱敏开关 |
| **任务/Session管理** | P1 重要 | 记录用户的每次分析任务，支持历史回溯。 | 1. 重启服务后数据不丢失<br>2. 可随时调阅历史分析结果 |
| **Prompt 模板管理** | P2 期望 | 允许用户自定义AI分析的提示词模板（如“谈判专家角色”、“风险分析角色”）。 | 1. 支持增删改查 Prompt 模板 |

## 3. 非功能需求

| 类型 | 要求 |
|-----|------|
| **性能** | 1. Excel (5万行内) 解析与清洗耗时 < 5秒<br>2. 图表渲染响应 < 1秒 |
| **安全** | 1. LLM 调用支持数据脱敏（将供应商名替换为代号）<br>2. 数据本地化存储，Docker容器重启不丢失 |
| **兼容** | 1. 适配 Chrome / Edge 最新版<br>2. 部署环境兼容 Aliyun ECS (Ubuntu/Debian) |
| **UI/UX** | 1. 严格遵循 Nexteer UI 规范 (红/黑/白配色)<br>2. 核心金额/数量字段使用等宽字体 (Roboto Mono) 以便对齐 |
| **网络** | 后端需支持配置 API Proxy，以确保在阿里云国内节点能顺利调用海外或国内大模型接口 |

## 4. 页面列表

| 页面 | 功能 | 设计稿参考 |
|-----|------|-------|
| **上传页** | 文件拖拽、表头映射确认 Modal | 简洁风格，重点在于映射关系的左右对照 |
| **全局概览页** | 核心KPI卡片、机会矩阵气泡图、Commodity双轴图 | 布局参考：顶部KPI，中部大图，底部Top榜单 |
| **品类详情页** | 供应商集中度饼图/帕累托图、项目列表 | 侧重于供应商对比和垄断风险提示 |
| **供应商详情页** | 供应商画像、What-If 模拟沙箱 | 需包含交互式输入框用于模拟报价 |
| **系统设置页** | LLM模型配置(Key/Url)、Prompt模板管理 | 表单式页面 |

## 4. 功能需求 (Functional Requirements)

### 4.1 数据上传与处理 (Data Ingestion)
- **文件支持**: Excel (.xlsx), CSV (.csv)
- **智能映射**:
  - 自动识别表头并映射到标准字段 (PNs, Quantity, APV, Opportunity 等)
  - 支持动态表头识别 (如 "2023 quantity" -> Quantity)
  - 映射置信度提示与人工修正界面
- **数据清洗**: 自动去除货币符号、百分号，处理空值

### 4.2 基础 BI 面板 (Basic BI Dashboard)

#### A. 总览页 (Commodity Assessment Overview)
**1. 核心 KPI 卡片**
- **Total Spending**: 所有记录的 APV 总和
- **Spending Covered**: Covered APV 总和
- **PNs Covered**: 唯一 PNs 数量
- **Suppliers Covered**: 唯一 Supplier 数量
- **Gap/Opportunity Identified**: Gap to Target pc cost 汇总
- **Gap % of APV**: (Total Opportunity / Total APV) %

**2. 品类全景 (Commodity Overview)**
- **图表**: 双轴图
  - 主轴 (柱状): APV $ vs Covered Spending $
  - 副轴 (折线): Gap in %
  - 维度: 按 Commodity 类型分组
- **数据表**: 包含 APV, Covered Spending, Covered PNs, Opportunity, Gap %, No. of Suppliers
- **Top 20 Lists**:
  - **Suppliers**: 按 Opportunity 排序，展示 APV, Gap%, 主营 Commodity
  - **Projects (PNs)**: 按 Opportunity 排序，展示 PNs, Part Description, APV, Gap%, Supplier

#### B. 品类详情页 (Commodity Detail Page)
*为每个 Commodity 类型提供独立视图*

**1. 局部总览**
- 复用总览页 KPI 逻辑，但数据范围仅限于当前 Commodity

**2. Top 5 Suppliers 分析**
- **图表**: 
  - 柱状: APV $ vs Opportunity $ (按 Opportunity 降序排列)
  - 折线: Gap in % (副轴)

**3. 供应商深度分析 (Top 5 Suppliers Detail)**
- **交互式图表**: 默认展示 APV 和 Opportunity，支持用户**手动添加数据系列** (如输入新数值，实时生成对比柱状图)
- **Top 10 PNs 表**: 该供应商名下 Opportunity 最大的 10 个零件 (PNs, Description, Opportunity, Gap%)

### 4.3 高级数据分析 (Advanced Analytics)

#### A. 象限分析 (Opportunity Matrix) - **必做**
- **图表类型**: 气泡图 (Bubble Chart)
- **X轴**: APV $ (采购额，代表重要性)
- **Y轴**: Gap in % (降本空间，代表潜力)
- **气泡大小**: Annual Opportunity $
- **业务价值**: 识别"现金牛"(优先攻坚)、"难啃骨头"和"长尾零件"

#### B. 供应商集中度 (Supplier Concentration) - **必做**
- **指标**: CR3, CR5 (Top Suppliers 份额占比)
- **业务价值**: 识别单一来源 (Single Source) 风险，辅助供应链安全决策

#### C. 后续规划 (V2)
- **价格离散度 (Price Benchmarking)**: 基于 Part Description 聚类，对比相似零件单价
- **长尾分析 (Tail Spend Analysis)**: 统计后 80% 供应商/零件的支出占比，辅助 VMI 决策

### 4.4 LLM 智能分析 (AI Insights)
- **覆盖范围**: 所有页面 (总览、品类详情、供应商详情)
- **功能**:
  - 上下文感知：自动获取当前页面的统计数据作为 Context
  - 模板选择：提供预设 Prompt (如"降本策略建议", "风险评估")
  - 报告生成：输出 Markdown 格式的分析报告

## 5. 数据需求

| 数据 | 关键字段 | 来源 |
|-----|------|------|
| **采购记录 (Source Data)** | `PNs`(主键), `Commodity`, `Supplier`, `Quantity`, `APV`, `TargetSpend`, `Opportunity` | 用户上传 Excel (经清洗入库) |
| **任务元数据 (Session)** | `SessionID`, `Period` (如2023), `UploadTime`, `FileName` | 系统自动生成 / 表头正则提取 |
| **LLM 配置** | `ProviderName`, `BaseUrl`, `ApiKey`, `ModelName`, `IsActive` | 用户在设置页输入 |
| **映射规则库** | `ExcelHeader` (原名), `SystemField` (目标名), `Weight` | 系统内置 + 用户行为学习(可选) |

## 6. 约束（💡 **注意**：具体技术选型在 `gemini.md` 中配置）

| 类型 | 约束内容 |
|-----|---------|
| **技术约束** | 1. 必须容器化交付 (Docker)，包含导出功能所需的系统依赖 (如Headless Chrome库)<br>2. 后端需实现 OpenAI 接口兼容层，以适配多种国产大模型<br>3. 严禁在代码中进行汇率换算，完全透传 Excel 原值 |
| **部署约束** | 生产环境为阿里云 ECS，需处理好网络连通性 (API Proxy) 和数据持久化挂载 |
| **资源约束** | 单人全栈开发，需采用高效的敏捷开发模式 |
| **时间约束** | 预计开发周期 4-6 周 |

---
**更新**：技术栈详情已移至 `gemini.md`，本文档专注于业务与架构约束。

---

## 7. 零部件成本差异分析模块 (Phase 5)

### 7.1 模块概述

**目标**: 为采购工程师提供单个零部件的详细成本结构差异分析工具，支持从总成本到子项的逐层下钻，帮助识别具体的成本偏差源头。

**使用场景**: 
- 供应商报价 vs 目标成本对比
- 新供应商引入时的成本分解验证
- 降本谈判前的精准备战

**集成方式**: 作为 Dashboard 的独立功能入口（新增 Tab 或卡片）

---

### 7.2 功能需求

| 功能 | 优先级 | 描述 | 验收标准 |
|-----|-------|------|---------|
| **固定格式Excel上传** | P0 必需 | 支持上传特定格式的零部件成本明细表（固定行号结构），解析并提取目标成本（H列）和供应商实际成本（I列）。 | 1. 解析准确率100%（基于标准格式）<br>2. 格式校验失败时给出明确错误提示<br>3. 上传成功后自动跳转到分析页面 |
| **层级树形结构展示** | P0 必需 | 以可折叠/展开的树形结构展示成本分解，最多支持5层（总成本→大类→细项→子项→最小单元）。 | 1. 支持点击展开/折叠<br>2. 差异金额和占比实时计算<br>3. 差异超标项（>5%）红色高亮 |
| **双视角加工成本分析** | P0 必需 | 加工成本支持两种breakdown模式：<br>**视角1**: 按工序分组（工序→设置/人工/间接）<br>**视角2**: 按成本类型分组（设置总计/人工总计/间接总计→各工序） | 1. 视角切换流畅，无刷新<br>2. 两种视角的总计金额一致<br>3. 默认展示"按工序"视角 |
| **瀑布图可视化** | P0 必需 | 使用ECharts瀑布图展示差异贡献（目标成本→+原材料差异→+外购件差异→...→实际成本）。 | 1. 自动根据差异金额生成瀑布图<br>2. 正差异（红色上升）、负差异（绿色下降）<br>3. 支持导出为图片 (PNG) |
| **历史记录管理** | P0 必需 | 保存每次上传的分析会话，支持查看历史分析结果和重新加载。 | 1. 历史列表显示零件号、供应商、上传时间<br>2. 点击历史记录即可恢复完整分析状态<br>3. 支持删除历史记录 |
| **导出功能** | P0 必需 | 支持导出：<br>1. **Excel表格**: 所有成本项的平铺表格（包含目标/实际/差异/占比）<br>2. **瀑布图PNG**: 高清图片<br>3. **完整PDF报告**（可选，Phase 5.1） | 1. Excel导出包含所有层级的成本明细<br>2. 瀑布图分辨率≥2x<br>3. PDF包含零件信息、成本树、瀑布图 |
| **多供应商横向对比** | P2 期望 (未来扩展) | 支持上传多个供应商的成本表，进行横向对比。 | 未来版本实现 |

---

### 7.3 数据结构定义

#### 7.3.1 Excel 表格结构（固定格式）

**关键信息提取点**:

| 行号 | 列 | 内容 | 说明 |
|------|---|------|------|
| 42 | H/I | Sell Price | 目标售价 / 供应商售价 |
| 44 | I | Supplier Name | 供应商名称 |
| 48 | I | Part Description | 零件描述 |
| 49 | I | Part Number | 零件号 |

**成本项解析规则**:

1. **原材料成本** (58-187行)
   - 每13行一项材料
   - 第1行: 材料描述 (E列)
   - 第12行: 成本 (H/I列)

2. **外购零部件成本** (194-693行)
   - 每10行一项
   - 第1行: 零部件描述 (E列)
   - 第9行: 成本 (H/I列)

3. **加工成本** (699-1850行)
   - 每23行一道工序
   - 第5行: 设置成本
   - 第16行: 直接人工成本
   - 第20行: 间接成本

4. **其他成本**
   - 管理费用 (1881-1884行)
   - 利润 (1887-1890行)
   - 零星成本 (1894-1897行)

#### 7.3.2 成本树层级结构

```
Level 1: 总采购成本 (Total Cost)
├─ Level 2: 生产成本 (Manufacturing Cost)
│  ├─ Level 3: 原材料成本 (Material Cost)
│  │  └─ Level 4: 材料A, 材料B, ...
│  ├─ Level 3: 外购件成本 (Purchased Components)
│  │  └─ Level 4: 零部件1, 零部件2, ...
│  └─ Level 3: 加工成本 (Processing Cost)
│     ├─ Level 4 (视角1 - 按工序): 工序1, 工序2, ...
│     │  └─ Level 5: 设置成本, 直接人工, 间接成本
│     └─ Level 4 (视角2 - 按类型): 设置成本总计, 直接人工总计, 间接成本总计
│        └─ Level 5: 工序1, 工序2, ...
├─ Level 2: 管理费用分摊 (SG&A)
├─ Level 2: 供应商利润 (Profit)
└─ Level 2: 其他成本 (Other Costs)
   └─ Level 3: 废料成本, 包装成本, 运费, 摊销
```

---

### 7.4 UI/UX 设计要求

#### 7.4.1 页面布局

```
┌───────────────────────────────────────────────────────────┐
│ [< 返回 Dashboard]  零部件成本差异分析  [历史记录 ▼]     │
├───────────────────────────────────────────────────────────┤
│ 零件号: PN123456  |  供应商: ABC Supply  |  上传时间: ... │
│ 目标成本: $125.50  |  实际成本: $132.80  |  差异: +$7.30 │
├───────────────────────────────────────────────────────────┤
│ ┌─────────────────────────┐ ┌─────────────────────────┐  │
│ │  成本树 (可展开)        │ │  瀑布图可视化           │  │
│ │                         │ │                         │  │
│ │ ▼ 总采购成本 +7.30      │ │   ┌────┬───┬───┬───┐   │  │
│ │   ├─ 生产成本 +5.20     │ │   │125 │+2 │+1 │   │   │  │
│ │   │  ├─ 原材料 +2.10    │ │   │    │   │   │132│   │  │
│ │   │  ├─ 外购件 +1.50    │ │   └────┴───┴───┴───┘   │  │
│ │   │  └─ 加工   +1.60    │ │                         │  │
│ │   ├─ SG&A     +1.20     │ │                         │  │
│ │   └─ 利润     +0.90     │ │                         │  │
│ └─────────────────────────┘ └─────────────────────────┘  │
├───────────────────────────────────────────────────────────┤
│              [导出Excel]  [导出瀑布图]  [导出PDF]        │
└───────────────────────────────────────────────────────────┘
```

#### 7.4.2 交互规范

1. **树节点样式**:
   - 正差异（超标）: 红色 `#E31837`
   - 负差异（节约）: 绿色 `#52C41A`
   - 无差异: 灰色 `#8C8C8C`
   - 差异占比 >5%: 粗体显示

2. **加工成本视角切换**:
   - Radio按钮: `[● 按工序分组] [○ 按成本类型分组]`
   - 切换时树结构平滑过渡（200ms动画）

3. **历史记录下拉**:
   - 显示最近10次分析
   - 格式: `PN123456 - ABC Supply (2024-12-03 10:30)`

---

### 7.5 API 接口定义

#### 接口 1: 上传成本明细表
```
POST /api/cost-variance/upload
Content-Type: multipart/form-data

Request:
- file: Excel文件 (.xlsx)

Response:
{
  "session_id": "uuid-xxxx",
  "part_number": "PN123456",
  "part_description": "转向柱总成",
  "supplier_name": "ABC供应商",
  "currency": "CNY",
  "target_price": 125.50,
  "supplier_price": 132.80,
  "total_variance": 7.30,
  "variance_pct": 5.82
}
```

#### 接口 2: 获取成本树
```
GET /api/cost-variance/{session_id}/tree?view=by_process

Query Parameters:
- view: "by_process" | "by_type" (默认: by_process)

Response:
{
  "session_id": "uuid-xxxx",
  "view": "by_process",
  "tree": {
    "item_id": "ROOT",
    "item_name": "总采购成本",
    "level": 1,
    "target_cost": 125.50,
    "actual_cost": 132.80,
    "variance": 7.30,
    "variance_pct": 5.82,
    "children": [...]
  }
}
```

#### 接口 3: 获取历史会话列表
```
GET /api/cost-variance/sessions?limit=10

Response:
{
  "sessions": [
    {
      "session_id": "uuid-xxxx",
      "part_number": "PN123456",
      "supplier_name": "ABC供应商",
      "upload_time": "2024-12-03T10:30:00Z",
      "total_variance": 7.30,
      "variance_pct": 5.82
    },
    ...
  ]
}
```

#### 接口 4: 导出Excel
```
GET /api/cost-variance/{session_id}/export/excel

Response:
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
File Download
```

---

### 7.6 技术约束

| 约束类型 | 要求 |
|---------|------|
| **解析准确性** | 基于固定行号解析，必须确保100%准确提取（通过单元测试验证） |
| **性能** | 树渲染耗时 < 500ms（即使有100+成本项） |
| **兼容性** | 前端虚拟滚动（react-window）处理大列表 |
| **数据持久化** | 所有会话数据存储在DuckDB，服务重启不丢失 |

---

### 7.7 验收标准

1. **功能完整性**:
   - ✅ 能上传标准格式Excel并准确解析所有成本项
   - ✅ 树形结构支持5层展开/折叠
   - ✅ 加工成本双视角切换流畅
   - ✅ 瀑布图正确展示差异贡献
   - ✅ 历史记录可正常加载和删除
   - ✅ 导出Excel和PNG功能正常

2. **数据准确性**:
   - ✅ 差异计算公式: `差异 = 实际 - 目标`
   - ✅ 差异占比公式: `占比 = 差异 / 目标总成本 * 100%`
   - ✅ 父级成本 = 所有子级成本之和

3. **用户体验**:
   - ✅ 界面符合 Nexteer UI 规范（红黑白配色）
   - ✅ 操作响应时间 < 1秒
   - ✅ 错误提示清晰友好

---

**版本**: 2.1.0 | **新增模块**: 成本差异分析 | **更新日期**: 2024-12-04